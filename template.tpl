___INFO___

{
  "displayName": "FirstImpressio.io Integration Tag",
  "description": "This tag adds support to the full suite of FirstImpression.io services, including monetization, adblock analysis, content filtering, ad placement management, and more",
  "securityGroups": [],
  "id": "cvt_temp_public_id",
  "type": "TAG",
  "version": 1,
  "brand": {
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALwAAAC8CAYAAADCScSrAAABhGlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9bpSKVDnYQEcxQnSwVFXHUKhShQqgVWnUwufQLmjQkKS6OgmvBwY/FqoOLs64OroIg+AHi4uqk6CIl/i8ptIjx4Lgf7+497t4B/kaFqWbXOKBqlpFOJoRsblUIviKIYYQRR1xipj4niil4jq97+Ph6F+NZ3uf+HH1K3mSATyCeZbphEW8QT29aOud94ggrSQrxOfGYQRckfuS67PIb56LDfp4ZMTLpeeIIsVDsYLmDWclQiaeIo4qqUb4/67LCeYuzWqmx1j35C0N5bWWZ6zSHkMQiliBCgIwayqjAQoxWjRQTadpPePgHHb9ILplcZTByLKAKFZLjB/+D392ahckJNymUALpfbPtjBAjuAs26bX8f23bzBAg8A1da219tADOfpNfbWvQICG8DF9dtTd4DLneAgSddMiRHCtD0FwrA+xl9Uw7ovwV619zeWvs4fQAy1FXqBjg4BEaLlL3u8e6ezt7+PdPq7wfW63LPLCgAWwAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAAPYQAAD2EBqD+naQAAAAd0SU1FB+MIAQsMJEgrqxQAAA8+SURBVHja7Z17dBRVnse/3Z3udBIS8iLESIJADHBWIAk4kwQUiMgjwA5KACE7OoIIYWQcdYWJAQTmLOOsKzquGBEP6OH9ODsGd1wdR0jAJJiHzICAEJAkNPJw5pAHnVd3de8fc8YRX1QnVZW6Vd/Pv7n1yL2f/tXv3rp1r8Xv9/tBiEmwsgoIhSeEwhNC4Qmh8IRQeEIoPCEUnhAKTwiFJ4TCE0LhCaHwhMITQuEJofCECEhQT17c7/ej9kwtamvPoL6uDm63G01NTQGfJyysF4KCbJrcc0REb8NLIUleuN3uLh8fFhYGm+2faoVHhKNvXF8MSk5GUv8kWK1W8wgveb0oLSnFO/v34/Dhw2i8do1hx0RERkUhIyMDOVOnInvCPXA6nZpe36LVJ36S14tdO3di0+ub4LpwgS1PEBUdhQcf+hkeXjAfvXr1Mo7wn9TUYMUzz+DM6TNsZfIt4uLisGLVKuRMmyq28H6/HxuLivDi+vWQvBJblvwgc+Y+gNVr18Jut4snvCRJWFlYiD27drMliWzG3DUGRRs3IiQ0VBzh/X4/CgsKKDvpEplZWdj81puqRHpVxoeKNmyg7KTLVJSX47l168SI8NVV1cib+wBzdtI9MS0WvLFlM8aOG6df4T0eD6ZNycG5s2e7fA6Hw4HOzk62OEH/2/rjvQ8+UDS1UfTF0/at2wKSPSgoCBMm3oupU6dh2IjhiI+PR1BQEFvaQLS1teGiy4WjR4+i+Pdv40hFhexj6+vqsXfPHszLy9NfhPd4PMi+eywuXbokq/zIUaOw7rnfYFByMq0wEUcqKlCw/Fe40NAgq/yAAQPwxwMfwmKx6KvTeuDDD2XLPjlnCrbu2E7ZTUhGZib2/f5/MGTIEFnlz58/j7/8+c+KXV8x4fe/XSyr3L/ccQdeePFFOBwOtr5JiYmJwWubXpc9neD9997Tl/CSJKHso49k9bxXr12D4OBgtrrJ6ZeYiEcXL5JVtvLjSn0Jf/qzz3D9+vWblktLT0daejpbmwAA5s7Lg03GtO5TJ09CkiT9CF9bWyur3L0TJ7KVyVdERUdhxIjUm5br7OzE5cuX9SO864JLVrnBQwazlckNpAxOkVXuy6tX9SN8S0uzrHKxsbFsYXIDkb0jZZVzu1v1I3x7e4esckqNpRLj4JA5gNHZ2aEf4eW+u7JY+c04+abw2g5PK2IgIzfpKsEOAYWX/cMAfxiki9mBnqYWMMATURBqamJzczP27t6Nw4cO4dzZc2htbTVsw4SHh2NQcjLGjhuH3FmzEBrW9U/eztbWYtvWbaiq/BhfXv2y2y9xnCEhGDhwICZNnoRZc+YI9eZcEeG1yOFPnjiBhQsewRWFXkDonaamJrhcLpSWlOCtN7dgy1tvIal//4DPs2/vXqx8phAej0fRe7ty+TIqysuxe+cuvLltK2JiYoSoVyGGTVrdrVi88FHTyP5N6uvq8fjSpQEfd+rkSRQWFCgq+7euceoUCpYtE6YuhRilKS5+G1988YWpc8/jx46juqo6oGPe3LxFk08tD3x4AOfOnaPwSnGopJS9LQBVlR8HVL6yslKze6sJ8MfIlOYH+FyQ6KE2FwJcolCp+SdyuKrhtXo+wqs8vt6VFYWNSHNzc0DltfwY3uPpNI/wauP1emk7AJ/k0++9+fwmEl7tYUm+2dI9fp/PRMKrfZMUXv9PH7+JhFd7lIaT0wQQ3kfhKXxPpxl+v4bCmymHV/smOY9egAgvmUd4tQOwlpHKSGj5ZFRqVQFGeIEq08wpjShPYSFyeFE6RGbGaqHwjPBmivA2m3mEVz2l8VF4/Q8sWMwjvOopjcSURv/CmyilMdKjmXRVeBOlNFyNgJgqpVF7IN7pdNIoIOCPpbUch2dKoyBJ/ZNoO4CI3r0DKi93wwFFfoyCBCUhOq3Dh4+g7QBSUm4PqPyAgQM0u7fExERGeKW4b+b9ppfdZrNh7PjxAR1zz4R7Nbk3p9OJrKzRjPBKkZqWpujWhSLywLx56NevX0DH/PShBwM+pissXrIEUdFRZhJe/Rt9du0aPPHUU91agUtEHA4H5j/yCFasWhl4zh8RgW07d2DkqFGqdaJ/+eST+PnSx4SpT2GW2rPZbPj50scwf8F8lJaU4vTpz9DQ0PCdHyr36hUOm+3bv+XQ0DDY7d//L3u9Etzu6z3+vzqdToSHh+P221OQmZXVrejZLzERu/ftxafHj6OmugYulwttba1dFtzpdMJut+O22wbg7nFjER0dLVQAEWapvX8QEhqKyTlTMDlnCnuxAXDHsGG4Y9gw09cDv6wgFF7PEZ4QRnhCGOEJYYQnFF6RGM+aJIzwhDCHJ4TCE6INQSLetOT1oq6+Hk2NjWhra9f8+nZ7ECIjo3Brv1sRFhYmTL15vV7U19Whqampy/UWERGBPn36IP6WePMKr1WE//zzz/HK717Gn/70AVrdPb9lpS3IhvT0dCzKz8e4AKfuaklVZSVee7UIRyoq0NHRocg54+Li8K8zfoLFS5YgMjKSnValKS8rw4zp07G/uFgXsv/9SSOhqrIKjzw8H//9u5d1WW/bt21D3gNzUVpSopjswN+3uHnj9U2YMW26ULsrCjE9uLm5Gb94bKluRP8uXn7pJZR9VKarezp37hx+vXqNqiu3uVwurCwsZKdVSfbt2YPGa9d0XZF+vx8bi4p0dU+7tu/QZLuggwcOCrOtqBApzeFDh4WozKrKSrS3t+vnfqqqNPuxf1JTwwivFA0N9UJUpsfjgSvArSXVpL6uTrNruVwuRnilaGluESZHvHatUTcpltvt1ux611uum0h4tdeWFGipPUny6uQ+JE2XGTfXDiCcPPa1hufCr0xpTCU8F35lp9VUwnMte0Z4pjSEEZ4pDaHw33N+pjRER8KrvUOHSBuAiLKbHYUnyjyNrEzvKLyZKtTKKmVKYyJsguxXSuGJQh1sVikjvKkiPIVnhGcOTwwV4aFuhHc6g4Wp0JAQfexQwqeuwBE+NraPMBUaF9eHVhleeJWjyfDhw4WozISEBPSNj6dVjPDdY8b99wlRmbmzZ9EoU+TwKkf49JEjMTM3V9cVeXtKChYsXEijGOGVYd1zv8Gi/MUIDtZXB9ZqtWJyzhTs2LVLqGX3zIoiS+1pMSJgCwrC08uXY8HChSgvK8PZ2lpcu9bYI9+QWmBBZFQUkpISkZGZicSkJJpkJuG1JDo6GtOmT2fLkZ7M4VmRhDk8IRSeEAOkNMxpCCM8IYzwRBu4kgQjPIUnjPAUnsITCm9YFHrTqm2E93g8+Ntf/waPp7Nb57HbHYiJjYHdbqfwFF5/fFJTg1df2YAjFRWKbS0THByMzKwsLH38FxiRmkojmNLog727d2Pu7DkoOXhQ0X2UOjo6UHLwIGbn5mJ/cbGxGpff14rZaT1//jxWFq6AJKm3bqPklVCwbDkuXbrEtIbC9yw7tm3XZPvFjo4O7Ny+w0CJPAUXMsJ/Ul2tWYVUfnzEQL7TeCEj/NWrVzW71kXXRaY0FL5nI3xnZ6dmFdLe0U7hKXzPImm5/aLko/AUvmfxSdrtqiFJxtnBw0j/i85SGpWF1zDCSwbalIxznERNaTSMVEbKArijoKCdVi2FN8oeTT6fjxFe3E6rlhHeGCHez+guboTXcjKmUeaf+BjdxY3wWr4wNEqE5wiNmsKrHE249ylTGlNFeE13xjNKhKfwKubwKifZVm4UFngOT+EFjvBW7SK8UcbhKbyaEV7lHJ6b/VJ4U0V4i1W7sGuUOeRaD6+KMrolRIS32x2aVYjd4TCE8KGh2m6fqZftOg0R4WOiozW7VnzfvoYQ3uFwICYmRrs2io0xj/BqR/jhqSM0q5C0kemGyVdH3XmnZtcaOnQoI7xSzJ4zR7O8d9bsOYYR/t8e/Kkm10lISMAwQfbSFUL4EampeHjBAtWvs3jJEgweMtgwwmdmZWFeXp7qndXVa9cKM5ImzB5Pz6woROGqlejdu7fi546KjsLqtWvw5L8/BaPx7No1WF5QgPDwcMXPPSg5GW9s2YzsCfcIUx/CLLVnsVjw8Pz5mJeXh5rqatTV1aGlueWrv0uSF263+wfPERzsvGGf14jeERg4cCDS0tPhMMjozDex2WxYuOhRPPizh1BeVoYzp8+gubnpOzu5TmfITc9ntwchJiYWQ4YORcrgFOEm2wmzT+s/pQ1G1ujRyBo9GiSwehufnY3x2dmmrgdOUiEUnhCtkDReFkXTcXg/+BUOuZG2tlbxhJfbcZE0WBCViEVHR4d4woeGhsgqp+WSeUSUCN8mu9OtG+HDwnrJKld3vo4tTG7gyuUrijqmifCJSYmyylVXV7GFyVf4fD4cPXpUVtn4+L76ET45OVlWuf/7w7toa21lSxMAQHlZOa5euXmEDwsLQ5+4OP0IP3DQIERFR920XHNzMza8soEtTeDz+bD+v56XVTY1LVWxN7qKCG+1WjFmzF2yym56fSNKS0rY4ibnxRfW49hfjskqm5GZqdh1FXvxNOP++2SVk7wSHstfYrgd84g8JEnC87/9LYo2yH/ST8mZqtj1LX6FJsJIkoQJ47NxoaFB9jHjs7OxKD8f6SPTucWi0UX3elFaeggvrV+PkydOyD7uzh/diZ179uhPeADYt3cvfvX0soCPi42NxeAhg5GQcCtsQVyhwEh4Oj24fPkSTnx6Ao2NjQEf/8aWzRg3frw+hZe8Xsy87358evw4W5p0m8ysLGzdsV3RcyoqPACcOnUKM38yg29VSbcICQnB2+/sxyCZQ96ad1r/wdChQ/Hrdf/BFiPdYtWa1YrLrorwADAzNxePP/EEW410icX5+Zg1e7Yq51Y8pfk6rxUV4YX/fJ5br5CAZH9q2dOqfTqoqvAA8Mf330fBsuVoampia5Lvz9lDQ/HsmtXInTVL1euoPvg9cdIkvPv+e5g4aRJblXwno8eMRvH/vqO67JpE+K9TXVWN1159FYdKS7m6rcmxWCz4cUYGFuUvxl13363ddf09kGBfaGjAu394FyUHD+L4sWNob2+nASYgIiICqWlpyMjMxJScKUhMStL+h+bv4R6l1+tFQ0MDvrh48YZ1ZuREiPCICPm5m9Wi6GJEPp8fLS0ttPgmOBwOhIWF4pZbEmTNqDW88IRoCWdsEQpPCIUnhMITQuEJofCEUHhCKDwhFJ4QCk8IhSeEwhNC4QmFJ4TCE0LhCRGR/wfVShH2S/RYJQAAAABJRU5ErkJggg==",
    "displayName": "",
    "id": "brand_dummy"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "valueValidators": [
      {
        "type": "POSITIVE_NUMBER"
      }
    ],
    "displayName": "Website ID",
    "simpleValueType": true,
    "name": "websiteId",
    "type": "TEXT"
  }
]


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://ecdn.analysis.fi/static/js/fab.js"
              },
              {
                "type": 1,
                "string": "https://ecdn.firstimpression.io/fi_client.js"
              },
              {
                "type": 1,
                "string": "https://cdn.firstimpression.io/fi.js?id=*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "fragment",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "query",
          "value": {
            "type": 8,
            "boolean": true
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "apd_options"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "fi_gtm_apd_debug"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fi_gtm_apd_debug"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "/"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const injectScript = require('injectScript');
const getUrl = require('getUrl');
const query = require('queryPermission');
const setInWindow = require('setInWindow');
const getCookieValues = require('getCookieValues');
const setCookie = require('setCookie');

// Check if FI supression is enabled:
if(getUrl('query').indexOf('disable_fi')!=-1) {
	log("disable_fi has been detected in URL. All of FirstImpression.io functionality is disabled for this page view.");
	data.gtmOnFailure();
	return;
}

// Options declaration:
var debugCookieName = 'fi_gtm_apd_debug';
var options = { 
  websiteId: data.websiteId,
  scheme: "https://"
};
setInWindow('apd_options', options, true);

// Include the adblock tracking script:
injectScript('https://ecdn.analysis.fi/static/js/fab.js', function(){}, function(){});


// Include the main JS bundle, switching to debug mode if needed:
var apdAdmin = 0;

if(getUrl('query').indexOf('apdAdmin')!=-1 || getUrl('fragment').indexOf('apdAdmin')!=-1 || getCookieValues(debugCookieName)=="1") {
  apdAdmin = 1;
  log("HEre");
  log(getUrl('query').indexOf('apdAdmin'));
  log(getUrl('fragment').indexOf('apdAdmin'));
  setCookie(debugCookieName, "1", {path: '/'});
}

injectScript(
  'https://' + (apdAdmin ? 'cdn' : 'ecdn') + '.firstimpression.io/' + (apdAdmin ? 'fi.js?id='+options.websiteId : 'fi_client.js'), 
  data.gtmOnSuccess, 
  data.gtmOnFailure
);


___NOTES___

Created on 8/18/2019, 5:10:08 PM
